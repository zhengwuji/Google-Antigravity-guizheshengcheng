name: Build and Release

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'public/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - '.github/workflows/**'
    paths-ignore:
      - 'README.md'
      - '**.md'

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          
      - name: å®‰è£…ä¾èµ–
        run: pnpm install
        continue-on-error: false
        
      - name: æ„å»º React åº”ç”¨
        id: build-react
        run: pnpm run build
        continue-on-error: false
        
      - name: æ‰“åŒ… Electron åº”ç”¨
        id: build-electron
        run: pnpm run electron:build
        continue-on-error: false
        
      - name: æ”¶é›†æ„å»ºäº§ç‰©
        if: success()
        run: |
          echo "BUILD_SUCCESS=true" >> $GITHUB_ENV
          $exePath = Get-ChildItem -Path "dist" -Filter "*.exe" -Recurse | Select-Object -First 1
          if ($exePath) {
            echo "EXE_PATH=$($exePath.FullName)" >> $GITHUB_ENV
            echo "EXE_NAME=$($exePath.Name)" >> $GITHUB_ENV
          }
        shell: pwsh
        
      - name: ä¸Šä¼ æ„å»ºé”™è¯¯æ—¥å¿—
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-error-logs
          path: |
            npm-debug.log*
            yarn-error.log*
            pnpm-debug.log*
            build/
          retention-days: 7
          
      - name: ç”Ÿæˆç‰ˆæœ¬å·å’Œæ›´æ–°æ—¥å¿—
        if: success()
        id: generate-changelog
        run: |
          $version = "v1.0.0-$(git rev-parse --short HEAD)"
          $date = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
          $commitMsg = git log -1 --pretty=%B
          $changelog = @"
          ## ğŸš€ è‡ªåŠ¨æ„å»ºç‰ˆæœ¬
          
          **æ„å»ºæ—¶é—´**: $date
          **ç‰ˆæœ¬å·**: $version
          **æäº¤ä¿¡æ¯**: $commitMsg
          
          ### ğŸ“¦ åŒ…å«å†…å®¹
          - âœ… å¤§ç™½è¯è§£é‡Š (Plain Explanations)
          - âœ… AI æ™ºèƒ½é…ç½® (Smart Config)
          - âœ… è‡ªåŠ¨å¤‡ä»½ (Auto Backup)
          - âœ… ä¸­æ–‡ä»»åŠ¡å¼ºåˆ¶ (Chinese Task)
          - âœ… å®Œæ•´ä½¿ç”¨æ–‡æ¡£
          
          ### ğŸ“¥ ä¸‹è½½è¯´æ˜
          ä¸‹è½½ \`Antigravity Rulesè§„åˆ™ç”Ÿæˆ Setup 1.0.0.exe\` å¹¶åŒå‡»å®‰è£…å³å¯ä½¿ç”¨ã€‚
          "@
          
          echo "VERSION=$version" >> $GITHUB_ENV
          echo "CHANGELOG<<EOF" >> $GITHUB_ENV
          echo "$changelog" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
        shell: pwsh
        
      - name: åˆ›å»º Release å¹¶ä¸Šä¼  EXE
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.VERSION }}
          name: Antigravity Rulesè§„åˆ™ç”Ÿæˆ ${{ env.VERSION }}
          body: ${{ env.CHANGELOG }}
          files: |
            dist/*.exe
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: æ„å»ºçŠ¶æ€é€šçŸ¥
        if: always()
        run: |
          if ($env:BUILD_SUCCESS -eq "true") {
            echo "âœ… æ„å»ºæˆåŠŸï¼Release å·²å‘å¸ƒåˆ°: https://github.com/${{ github.repository }}/releases"
          } else {
            echo "âŒ æ„å»ºå¤±è´¥ï¼è¯·æŸ¥çœ‹æ„å»ºæ—¥å¿—å’Œé”™è¯¯ä¿¡æ¯ã€‚"
            exit 1
          }
        shell: pwsh
