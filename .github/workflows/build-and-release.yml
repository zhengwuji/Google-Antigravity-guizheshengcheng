name: Build and Release

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.gitignore'

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          
      - name: Install dependencies
        run: pnpm install
        continue-on-error: false
        
      - name: Build React app
        id: build-react
        run: pnpm run build
        continue-on-error: false
        
      - name: Build Electron app
        id: build-electron
        run: pnpm run electron:build
        continue-on-error: false
        
      - name: Collect build artifacts
        if: success()
        run: |
          echo "BUILD_SUCCESS=true" >> $env:GITHUB_ENV
          $exePath = Get-ChildItem -Path "dist" -Filter "*.exe" -Recurse | Select-Object -First 1
          if ($exePath) {
            echo "EXE_PATH=$($exePath.FullName)" >> $env:GITHUB_ENV
            echo "EXE_NAME=$($exePath.Name)" >> $env:GITHUB_ENV
          }
        shell: pwsh
        
      - name: Upload build error logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-error-logs
          path: |
            npm-debug.log*
            yarn-error.log*
            pnpm-debug.log*
            build/
          retention-days: 7
          
      - name: Generate version and changelog
        if: success()
        id: generate-changelog
        run: |
          $version = "v1.0.0-$(git rev-parse --short HEAD)"
          $date = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
          $commitMsg = git log -1 --pretty=%B
          $changelog = @"
          ## ğŸš€ è‡ªåŠ¨æ„å»ºç‰ˆæœ¬
          
          **æ„å»ºæ—¶é—´**: $date
          **ç‰ˆæœ¬å·**: $version
          **æäº¤ä¿¡æ¯**: $commitMsg
          
          ### ğŸ“¦ åŒ…å«å†…å®¹
          - âœ… å¤§ç™½è¯è§£é‡Š (Plain Explanations)
          - âœ… AI æ™ºèƒ½é…ç½® (Smart Config)
          - âœ… è‡ªåŠ¨å¤‡ä»½ (Auto Backup)
          - âœ… ä¸­æ–‡ä»»åŠ¡å¼ºåˆ¶ (Chinese Task)
          - âœ… å®Œæ•´ä½¿ç”¨æ–‡æ¡£
          
          ### ğŸ“¥ ä¸‹è½½è¯´æ˜
          ä¸‹è½½ Antigravity Rulesè§„åˆ™ç”Ÿæˆ Setup 1.0.0.exe å¹¶åŒå‡»å®‰è£…å³å¯ä½¿ç”¨ã€‚
          "@
          
          echo "VERSION=$version" >> $env:GITHUB_ENV
          $changelog | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "CHANGELOG<<EOF" >> $env:GITHUB_ENV
          echo $changelog >> $env:GITHUB_ENV
          echo "EOF" >> $env:GITHUB_ENV
        shell: pwsh
        
      - name: Create Release and upload EXE
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.VERSION }}
          name: Antigravity Rulesè§„åˆ™ç”Ÿæˆ ${{ env.VERSION }}
          body: ${{ env.CHANGELOG }}
          files: dist/*.exe
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Build status notification
        if: always()
        run: |
          if ($env:BUILD_SUCCESS -eq "true") {
            echo "âœ… æ„å»ºæˆåŠŸï¼Release å·²å‘å¸ƒåˆ°: https://github.com/${{ github.repository }}/releases"
          } else {
            echo "âŒ æ„å»ºå¤±è´¥ï¼è¯·æŸ¥çœ‹æ„å»ºæ—¥å¿—å’Œé”™è¯¯ä¿¡æ¯ã€‚"
            exit 1
          }
        shell: pwsh
